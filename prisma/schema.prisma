generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MUNICIPALITY
  COMPANY
  ADMIN_MASTER
}

enum TypeGroup {
  SERVICE
  OPPORTUNITY
  CATEGORY
}

enum UnitType {
  UF
  MUNICIPALITY
}

enum EmploymentType {
  CLT
  PJ
  OTHERS
}

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  document String @unique
  phone    String @unique
  password String

  role Role @default(MUNICIPALITY)

  municipality Municipality? @relation("UserMunicipality")
  Company      Company?      @relation("UserCompany")

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("users")
}

model Municipality {
  id                 String   @id @default(uuid())
  name               String
  guardInitialDate   DateTime
  guardCount         Int
  trafficInitialDate DateTime
  trafficCount       Int
  federativeUnit     String
  unitType           UnitType

  userId String @unique
  user   User   @relation("UserMunicipality", fields: [userId], references: [id])

  allocationDepartments AllocationDepartment[]
  maintenanceContracts  MaintenanceContract[]
  qualifiedStaff        QualifiedStaff[]
  projectsPartnerships  ProjectPartnership[]
  managements           Management[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("municipalities")
}

model AllocationDepartment {
  id          String @id @default(uuid())
  description String
  address     String

  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime?       @updatedAt
  RequestedItem RequestedItem[]

  @@map("allocation_departments")
}

model MaintenanceContract {
  id          String @id @default(uuid())
  description String
  attachment  String

  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime?       @updatedAt
  RequestedItem RequestedItem[]

  @@map("maintenance_contracts")
}

model QualifiedStaff {
  id             String         @id @default(uuid())
  name           String
  sector         String
  education      String
  experience     String
  employmentType EmploymentType
  document       String
  isResponsible  Boolean

  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("qualified_staffs")
}

model ProjectPartnership {
  id        String @id @default(uuid())
  term      String
  agency    String
  objective String
  status    String

  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("project_partnerships")
}

model Management {
  id          String   @id @default(uuid())
  initialDate DateTime
  endDate     DateTime

  managerName    String
  managerCpf     String
  managerEmail   String
  managerAddress String
  managerPhone   String

  adminManagerName    String
  adminManagerCpf     String
  adminManagerEmail   String
  adminManagerAddress String
  adminManagerPhone   String

  legislationName    String
  legislationCpf     String
  legislationEmail   String
  legislationAddress String
  legislationPhone   String

  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("managements")
}

model Opportunity {
  id                    String   @id @default(uuid()) @map("id")
  title                 String   @unique
  slug                  String   @unique
  responsibleAgency     String
  description           String
  availableValue        Decimal
  minValue              Decimal
  maxValue              Decimal
  initialDeadline       DateTime
  finalDeadline         DateTime
  requiresCounterpart   Boolean
  counterpartPercentage Decimal?
  isActive              Boolean  @default(true)
  releasedForAll        Boolean  @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  Type   Type   @relation(fields: [typeId], references: [id], onDelete: Cascade)
  typeId String

  requiredDocuments RequiredDocument[]
  Project           Project[]

  @@map("opportunities")
}

model RequiredDocument {
  id          String @id @default(uuid())
  name        String
  description String
  model       String

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String

  @@map("required_documents")
}

model Type {
  id          String    @id @default(uuid())
  description String    @unique
  group       TypeGroup
  parentId    String?

  parent   Type?  @relation("TypeHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Type[] @relation("TypeHierarchy")

  opportunities Opportunity[]
  baseProducts  BaseProduct[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("types")
}

model BaseProduct {
  id                   String   @id @default(uuid())
  code                 String   @unique
  name                 String
  technicalDescription String
  budget1              Decimal
  budget1Validity      DateTime
  budget2              Decimal
  budget2Validity      DateTime
  budget3              Decimal
  budget3Validity      DateTime
  unitValue            Decimal

  Type   Type   @relation(fields: [typeId], references: [id], onDelete: Cascade)
  typeId String

  specificProducts SpecificProduct[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime?       @updatedAt
  RequestedItem RequestedItem[]

  @@map("base_products")
}

model Company {
  id String @id @default(uuid())

  cnpj                 String @unique
  legalName            String
  tradeName            String
  address              String
  email                String @unique
  phone                String @unique
  site                 String
  portfolioDescription String

  userId String @unique
  user   User   @relation("UserCompany", fields: [userId], references: [id], onDelete: Cascade)

  SpecificProduct SpecificProduct[]

  PriceRegistrationRecord PriceRegistrationRecord[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("companies")
}

model SpecificProduct {
  id             String   @id @default(uuid())
  brand          String
  model          String
  description    String
  unitValue      Decimal
  warrantyMonths Int
  budget         Decimal
  budgetValidity DateTime

  baseProduct   BaseProduct @relation(fields: [baseProductId], references: [id], onDelete: Cascade)
  baseProductId String

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId String

  priceRegistrationRecordItems PriceRegistrationRecordItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("specific_products")
}

model PriceRegistrationRecord {
  id            String   @id @default(uuid())
  publicAgency  String
  number        String   @unique
  year          Int
  effectiveDate DateTime
  status        String

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  priceRegistrationRecordItems PriceRegistrationRecordItem[]

  Company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  @@map("price_registration_records")
}

model PriceRegistrationRecordItem {
  id                   String  @id @default(uuid())
  unitValue            Decimal
  quantity             Int
  minAdherenceQuantity Int
  maxAdherenceQuantity Int

  priceRegistrationRecordId String
  priceRegistrationRecord   PriceRegistrationRecord @relation(fields: [priceRegistrationRecordId], references: [id], onDelete: Cascade)

  specificProductId String
  specificProduct   SpecificProduct @relation(fields: [specificProductId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("price_registration_record_items")
}

model Field {
  id       String  @id @default(uuid())
  name     String
  value    String?
  parentId String?

  parent   Field?  @relation("FieldHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Field[] @relation("FieldHierarchy")

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  ProjectType   ProjectType? @relation(fields: [projectTypeId], references: [id])
  projectTypeId String?

  @@map("fields")
}

model ProjectType {
  id   String @id @default(uuid())
  name String

  fields  Field[]
  Project Project[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("project_types")
}

model RequestedItem {
  id       String  @id @default(uuid())
  quantity Decimal

  baseProduct   BaseProduct @relation(fields: [baseProductId], references: [id], onDelete: Cascade)
  baseProductId String

  allocationDepartment   AllocationDepartment @relation(fields: [allocationDepartmentId], references: [id], onDelete: Cascade)
  allocationDepartmentId String

  maintenanceContract   MaintenanceContract @relation(fields: [maintenanceContractId], references: [id], onDelete: Cascade)
  maintenanceContractId String

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("requested_itens")
}

model Project {
  id                            String  @id @default(uuid())
  responsibleCpf                String
  responsibleName               String
  responsibleEmail              String
  responsiblePhone              String
  counterpartCapitalItem        String
  counterpartCapitalValue       Decimal
  counterpartOperatingCostCode  String
  counterpartOperatingCostValue Decimal
  totalValue                    Decimal
  requestedValue                Decimal
  baseValue                     Decimal

  projectType   ProjectType @relation(fields: [projectTypeId], references: [id], onDelete: Cascade)
  projectTypeId String

  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  opportunityId String

  RequestedItem RequestedItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@map("projects")
}
